name: Release Metadata

on:
  schedule:
    - cron: '0 5 * * 1/3' # At 5:00am on Monday and Thursday
  workflow_dispatch:
    inputs:
      force:
        description: 'Force regeneration of all metadata'
        type: boolean
        default: false

concurrency:
  group: release-metadata
  cancel-in-progress: false

jobs:
  generate:
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64-linux
            runner: ubuntu-latest
          - arch: aarch64-linux
            runner: ubuntu-24.04-arm
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      packages: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install tools
        run: |
          ARCH="$(uname -m)-linux"
          sudo apt-get update
          sudo apt-get install -y zstd xz-utils jq

          # Download sbuild
          curl -fsSL "https://github.com/pkgforge/sbuilder/releases/download/nightly/sbuild-${ARCH}" \
            -o /usr/local/bin/sbuild || {
            echo "::error::Failed to download sbuild"
            exit 1
          }
          chmod +x /usr/local/bin/sbuild
          sbuild --version

          # Download soar for SDB generation
          curl -fsSL "https://github.com/pkgforge/soar/releases/download/nightly/soar-${ARCH}" \
            -o /usr/local/bin/soar || {
            echo "::error::Failed to download soar"
            exit 1
          }
          chmod +x /usr/local/bin/soar

      - name: Generate metadata
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p /tmp/output

          sbuild meta generate \
            -a "${{ matrix.arch }}" \
            -r ./packages/ \
            -o /tmp/output/metadata.json \
            || {
            echo "::warning::metadata generation failed or no packages found"
          }

          if [ -f "/tmp/output/metadata.json" ]; then
            mv "/tmp/output/metadata.json" "/tmp/output/metadata-${{ matrix.arch }}.json"
            echo "::notice::metadata generated"
            jq 'length' "/tmp/output/metadata-${{ matrix.arch }}.json"
          else
            echo "::warning::No metadata generated"
          fi

      - name: List outputs
        run: |
          echo "=== Generated files ==="
          ls -lah /tmp/output/ || echo "No files"

          for f in /tmp/output/*.json; do
            if [ -f "$f" ]; then
              echo "=== $(basename $f) ==="
              jq '.[0:2]' "$f" 2>/dev/null || cat "$f"
            fi
          done

      - name: Generate SDB metadata
        run: |
          cd /tmp/output

          for json_file in *.json; do
            if [ -f "$json_file" ]; then
              sdb_file="${json_file%.json}.sdb"

              echo "Converting $json_file to $sdb_file"
              soar json2db "$json_file" "$sdb_file" -r "soarpkgs" || {
                echo "::warning::Failed to convert $json_file to SDB"
                continue
              }
            fi
          done

          echo "=== SDB files generated ==="
          ls -lah *.sdb 2>/dev/null || echo "No SDB files"

      - name: Compress outputs
        run: |
          cd /tmp/output

          for file in *.json *.sdb; do
            if [ -f "$file" ]; then
              # Compress with zstd
              zstd -19 "$file" -o "${file}.zstd"
            fi
          done

          ls -lah

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: metadata-${{ matrix.arch }}
          path: |
            /tmp/output/*.json
            /tmp/output/*.json.zstd
            /tmp/output/*.sdb
            /tmp/output/*.sdb.zstd
          retention-days: 7

  release:
    needs: generate
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: /tmp/artifacts
          merge-multiple: true

      - name: List artifacts
        run: |
          echo "=== Downloaded artifacts ==="
          ls -lah /tmp/artifacts/ || echo "No artifacts"

      - name: Create release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="$(date -u '+%Y%m%d.%H%M%S')"

          # Check if we have any files
          if [ -z "$(ls -A /tmp/artifacts/ 2>/dev/null)" ]; then
            echo "::warning::No artifacts to release"
            exit 0
          fi

          # Generate release notes
          cat > /tmp/release_notes.md << EOF
          ## Metadata Release

          **Generated**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          ### Contents

          | File | Size |
          |------|------|
          EOF

          for f in /tmp/artifacts/*; do
            if [ -f "$f" ]; then
              size=$(ls -lh "$f" | awk '{print $5}')
              echo "| $(basename $f) | $size |" >> /tmp/release_notes.md
            fi
          done

          cat >> /tmp/release_notes.md << EOF

          ---
          *This release was generated automatically.*
          EOF

          # Create the release
          gh release create "$VERSION" \
            --title "Metadata $VERSION" \
            --notes-file /tmp/release_notes.md \
            --repo "${{ github.repository }}" \
            /tmp/artifacts/* || {
            echo "::error::Failed to create release"
            exit 1
          }

          echo "::notice::Created release $VERSION"
